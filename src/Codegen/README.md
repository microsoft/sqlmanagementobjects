# Codegen

 This file contains the definitions of the various objects in the SMO Object Model and what properties these objects define.

## SQL Version support

Codegen.cs defines enumerations and arrays that map server version numbers to supported properties.

When SQL Server vbumps, update codegen.cs.
Lines that need attention are commented with `// VBUMP`

```C#

    private enum SingletonSupportedVersionFlags
    {
        NOT_SET = 0,
        v7_0 = 1,
        v8_0 = 2,
        v9_0 = 4,
        v10_0 = 8,
        v10_50 = 16,
        v11_0 = 32,
        v12_0 = 64,
        v13_0 = 128,
        v14_0 = 256,
        v15_0 = 512,
        v16_0 = 1024,
    }

    private static KeyValuePair<ServerVersion, int>[] m_SingletonSupportedVersion =
    {
        new KeyValuePair<ServerVersion, int>(new ServerVersion(7,0), (int)SingletonSupportedVersionFlags.v7_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(8,0), (int)SingletonSupportedVersionFlags.v8_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(9,0), (int)SingletonSupportedVersionFlags.v9_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(10,0), (int)SingletonSupportedVersionFlags.v10_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(10,50), (int)SingletonSupportedVersionFlags.v10_50),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(11,0), (int)SingletonSupportedVersionFlags.v11_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(12,0), (int)SingletonSupportedVersionFlags.v12_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(13,0), (int)SingletonSupportedVersionFlags.v13_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(14,0), (int)SingletonSupportedVersionFlags.v14_0),
        // The build number should probably be 65535 for all the above
        // However, that does not matter for two reasons:
        // - if there is another line after this one, we are safe: any M.m.b with b>0 observed in 
        //   in object xml files (the ones with the object definitions) will be considered
        //   "supported" by matching the next entry.
        // - we rarely seem to rely on min_build/max_build attributes.
        new KeyValuePair<ServerVersion, int>(new ServerVersion(15,0,ushort.MaxValue), (int)SingletonSupportedVersionFlags.v15_0),
        new KeyValuePair<ServerVersion, int>(new ServerVersion(16,0,ushort.MaxValue), (int)SingletonSupportedVersionFlags.v16_0),
    };

```

Similar arrays exist for cloud versions

## CFG.XML

See [cfg.xsd](./cfg.xsd) for the schema of the cfg.xml file. Editors such as Visual Studio/VS Code will automatically read the schema and provide hover/auto-completion support as well.

Below are the attributes allowed in an object element

## Additional attributes read if cfg file isn't specified in SFC Config.xml

### Type

## Collections_codegen.proj

Collections of SMO objects are generated by the SmoCollectionGenCompile target collections_codegen.proj. This project should be built manually whenever a collection needs to be created/updated.
`msbuild collections_codegen.proj`

This takes in a template file (usually schema_generic_collection.cs for schema owned objects, or generic_collection.cs for normal collections) and replaces a set of defined tokens with the values passed in through the RemainingMacros definition.

e.g.

```xml
<SmoCollectionGenCompile Include="Database">
      <MappedTypeVariable>database</MappedTypeVariable>
      <Namespace>Microsoft.SqlServer.Management.Smo</Namespace>
      <KeyType>string</KeyType>
      <CollectionTemplate>$(SmoDirectory)\generic_collection.cs</CollectionTemplate>
      <Parent>Server</Parent>
      <RemainingMacros>/DSEALED /DDATABASE /DITEM_BY_ID</RemainingMacros>
 </SmoCollectionGenCompile>
```

MappedTypeVariable, Namespace, KeyType and Parent are all items that the target replaces appropriate macros in the template file with (MAPPED_TYPE_VAR, NAMESPACE_NAME, KEY_TYPE and PARENT respectively.

1. MappedTypeVariable - the object type name (replaces MAPPED_TYPE_VAR in the template)
2. NameSpace - Microsoft.SqlServer.Management.Smo (replaces NAMESPACE_NAME in the template)
3. KeyType - either int (For objects with an objectID but no name) or string  (for all named objects) (replaces KEY_TYPE in the template)
4. CollectionTemplate -  The template file to use
5. Parent - the parent object type (replaces PARENT in the template)
6. Remaining macros - these determine the lookup functions that will be autogenerated, typically you will include /DSEALED And /DITEM_BY_ID for all named objects, and just /DSEALED for non-named objects

You can also just create the collection manually and compile it in yourself (add it to Microsoft.SqlServer.Smo.csproj), this is useful if you're doing a lot of customization.

A mix of the two is also allowed as well. See Endpoint collection EndpointBase.cs as an example. The proj then has this definition

```xml
<SmoCollectionGenCompile Include="Endpoint">
      <MappedTypeVariable>endpoint</MappedTypeVariable>
      <Namespace>Microsoft.SqlServer.Management.Smo</Namespace>
      <KeyType>string</KeyType>
      <CollectionTemplate>$(SmoDirectory)\generic_collection.cs</CollectionTemplate>
      <Parent>Server</Parent>
      <RemainingMacros>/DSEALED /DITEM_BY_ID /DPARTIAL_KEYWORD=partial</RemainingMacros>
 </SmoCollectionGenCompile>
```

Which has the Partial keyword to allow the class definitions to be merged. 

Some classes also define their own collection templates. This can be useful if you plan on having multiple collections use the same definition. If only one collection is using a template though it's easier just to full create the collection definition and put it in the Smo folder. 

```xml
   <SmoCollectionGenCompile Include="ColumnEncryptionKeyValue">
      <MappedTypeVariable>columnEncryptionKeyValue</MappedTypeVariable>
      <Namespace>Microsoft.SqlServer.Management.Smo</Namespace>
      <KeyType>int</KeyType>
      <CollectionTemplate>$(SmoDirectory)\columnencryptionkeyvalue_generic_collection.cs</CollectionTemplate>
      <Parent>ColumnEncryptionKey</Parent>
      <RemainingMacros>/DSEALED</RemainingMacros>
    </SmoCollectionGenCompile>
```
